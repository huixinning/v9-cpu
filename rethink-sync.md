# Rethink the sync

### 回新宁 2015210865 白帅 P15240002

> Nightingale, E. B., Veeraraghavan, K., Chen, P. M., & Flinn, J. (2008). Rethink the sync. ACM Transactions on Computer Systems (TOCS), 26(3), 6.

文章中提出了一个新颖的本地文件I/O模型，表面上提供可靠简单的同步文件I/O接口，但是在性能上又很接近高效的异步I/O。这种文件系统称为外同步文件系统，并且实现了xsyncfs，提供与同步方式挂载的ext3文件系统相同的持久和顺序保障。在I/O密集型测试对比中，xsyncfs相比异步方式挂载的ext3文件系统只有7%以内的性能损耗，对比与同步方式挂载的ext3文件系统有2个数量级的性能提升。

外同步文件系统有两个设计原则，第一外同步文件系统中外同步指的是从外在的观察行为看而不是系统本身的实现，其二，应用程序的状态是操作系统的内部属性，外部实体不能直接观察到应用状态。在同步的文件系统中，程序中产生的任何I/O操作都会阻塞，直到I/O完成程序才能继续执行。外同步中定义的同步是从观察行为上来定义的，其解释是外部的观察者不能区分同步文件系统和外同步文件系统的输出。所以观察者是谁需要明确的定义。通常的操作系统中是以应用为中心的视图，应用程序作为外部的观察实体观察自己的行为，在这种视图中，系统调用的返回也被认为是外部可见的。但是实际上计算机系统的观察者是用户，应用状态只有通过输出到屏幕或是网络这样的外部设备才能被用户观察到。这样可以考虑一个以用户为中心的视图，只有被送到外部设备上的数据才认为是可见的，在这种视图中，系统调用的返回和应用状态的改变等都是不可见的。外部设备受到操作系统的控制，应用只能通过操作系统产生外部输出事件，所以用户为中心的视图是可以由操作系统控制的。

外同步文件系统处理I/O操作与同步文件系统不同的是外同步文件系统不进行磁盘commit操作，其他操作基本都是相同的，包括有效性验证以及改变内存中的状态等。外同步文件系统中将多个磁盘commits合并到一组，在一个文件系统事务中完成。如果一个外部输出跟随着一个外同步I/O操作，那么直到这个外同步I/O完成磁盘commit，外部输出才可见。

操作系统会追踪文件修改和外部输出之间的因果关系。当一个进程向文件中写入内容，它就继承它写的还未提交的数据的提交依赖。当一个进程通过系统调用修改其他内核对象的时候，操作系统会对这一内核对象标记与该进程相同的提交依赖。当一个进程观察其他有提交依赖的内核对象时，该进程也会继承这些提交依赖。如果一些系统调用无法追踪因果关系流，那么涉及到这一系统调用的程序就会被阻塞，直到其中的文件操作都提交到磁盘中。一个进程产生的外部输出继承进程的提交依赖。操作系统会缓存输出直到直到最后的依赖也提交到磁盘中。

外同步文件系统主要带来两方面性能提升：
1. 多个文件修改集中在一起通过一次文件系统事务（transaction）完成。在一次事务中，如果一个临时文件创建后又被删除，就不会有文件块写入磁盘。相反在同步文件系统中，这样的操作会涉及到多次磁盘操作。
2. 缓存屏幕输出。操作系统会缓存输出并允许产生输出的程序继续执行。

在外同步文件系统中，会延迟提交磁盘commit使得更多的commit在一起通过一次文件系统事务完成。但是这样的延迟会增加输出的延时。所以在外同步文件系统中当有外部输出时，就触发提交之前的所有磁盘commits。通过这样达到一定的权衡。

外同步文件系统的一些限制：
1. 不能从文件错误中恢复。因为文件操作还没实际提交到磁盘中时应用程序已经继续执行，如果文件操作出现错误则程序没法恢复到相应的执行点。
2. 外同步文件系统中可能会由于严重的系统宕机丢失没有提交的文件内容。为了解决这一问题，外同步文件系统每隔5秒进行一次额外的文件事务提交。
3. 多种文件系统的文件操作不能放在同一次文件事务中完成。
